<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StatsManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jcommon stats package</a> &gt; <a href="index.html" class="el_package">com.facebook.stats</a> &gt; <span class="el_source">StatsManager.java</span></div><h1>StatsManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012 Facebook, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.facebook.stats;

import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.lang.IllegalArgumentException;

import org.apache.log4j.Logger;

/**
 * This was written to resemble some older libraries.  You may find
 * more functionality in StatsUtil.java.
 *
 * See com.facebook.fb303.stats.HistoryManager for more info on how
 * this works.
 *
 * The parameters &quot;shortName&quot; refer to a stat name such as &quot;queries&quot;
 * or &quot;cpu_load&quot;, and &quot;fullName&quot; refer to the longer
 * &quot;queries.sum.600&quot;, &quot;cpu_load.avg.3600&quot;.
 */

/**
 * Each stat's name corresponds to a single underlying counter, but
 * each counter can be exported for different uses (ExportTypes). For
 * details see com.facebook.fb303.stats.HistoryManager.
 */
public class StatsManager implements HistoryManager {
<span class="fc" id="L45">  private static Logger logger = Logger.getLogger(StatsManager.class);</span>

  private ConcurrentHashMap&lt;String, Integer&gt; typeMap;
  // todo: handle mutliple shortName/types
  private ConcurrentHashMap&lt;String, MultiWindowGauge&gt; counterMap;

  /**
   * Creates a StatsMgr instance with default settings for the internal
   * ConcurrentHashMaps.
   */
  public StatsManager() {
<span class="fc" id="L56">    this(16, 0.75f, 16);</span>
<span class="fc" id="L57">  }</span>

  /**
   * Creates a StatsMgr instance with the specified initial capacity and
   * concurrency level for the ConcurrentHashMaps used internally.
   *
   * @param initialNumKeys:  expected initial number of keys
   * @param loadFactor:  load factor of the internal hash maps
   * @param concurrencyLevel:  estimated number of concurrently updating threads
   */
  public StatsManager(int initialNumKeys,
                      float loadFactor,
                      int concurrencyLevel) 
<span class="fc" id="L70">  {</span>
<span class="fc" id="L71">    logger.trace(&quot;StatsMgr Created&quot;);</span>
<span class="fc" id="L72">    this.typeMap =</span>
      new ConcurrentHashMap&lt;String, Integer&gt;(initialNumKeys,
                                             loadFactor,
                                             concurrencyLevel);
<span class="fc" id="L76">    this.counterMap =</span>
      new ConcurrentHashMap&lt;String, MultiWindowGauge&gt;(initialNumKeys,
                                                      loadFactor,
                                                      concurrencyLevel);
<span class="fc" id="L80">  }</span>

  private void ensureStat(String shortName) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">    if (counterMap.containsKey(shortName)) {</span>
<span class="fc" id="L84">      return;</span>
    }
<span class="fc" id="L86">    MultiWindowGauge mwg = new MultiWindowGauge();</span>
<span class="fc" id="L87">    MultiWindowGauge wasGauge = counterMap.putIfAbsent(shortName, mwg);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">    if (wasGauge == null) {</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">      if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L90">        logger.debug(&quot;Created stat &quot; + shortName);</span>
      }
    } else {
<span class="nc bnc" id="L93" title="All 2 branches missed.">      if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L94">        logger.trace(&quot;almost accidentally created stat&quot; + shortName</span>
                + &quot; twice.  phew...&quot;);
      }
    }
<span class="fc" id="L98">  }</span>

  private void ensureType(String shortName, ExportType etype) {
<span class="fc" id="L101">    boolean hasType = typeMap.containsKey(shortName);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">    if (!hasType) {</span>
<span class="fc" id="L103">      Integer prior = typeMap.putIfAbsent(shortName, etype.value());</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">      if (prior == null) {</span>
<span class="fc" id="L105">        return;</span>
      }
      // some other thread got there first
    }
<span class="fc" id="L109">    Integer bitmask = ExportType.NONE.value();</span>
    boolean done;
    Integer newValue;
<span class="fc" id="L112">    int tries = 0;</span>
    do {
<span class="fc" id="L114">      bitmask = typeMap.get(shortName);</span>
<span class="fc" id="L115">      newValue = bitmask | etype.value();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">      if (bitmask == newValue) {</span>
<span class="nc" id="L117">        break;</span>
      }
<span class="fc" id="L119">      done = typeMap.replace(shortName, bitmask, newValue);</span>
<span class="fc" id="L120">      tries++;</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">    } while (!done);</span>

<span class="pc bpc" id="L123" title="1 of 2 branches missed.">    if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L124">      logger.trace(&quot;Updated type for &quot; + shortName + &quot;, added &quot; + etype</span>
          + &quot;, was &quot; + bitmask + &quot;, now &quot; + newValue + &quot; (after &quot; + tries
          + &quot; tries)&quot;);
    }
<span class="fc" id="L128">    return;</span>
  }

  public void addStatExportType(String shortName, ExportType etype) {
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">    if (shortName == null) {</span>
<span class="nc" id="L133">      logger.error(&quot;Null value passed as key&quot;);</span>
<span class="nc" id="L134">      return;</span>
    }
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (etype == null) {</span>
<span class="nc" id="L137">      logger.error(&quot;Null value passed as exportType&quot;);</span>
<span class="nc" id="L138">      return;</span>
    }
<span class="fc" id="L140">    ensureStat(shortName);</span>
<span class="fc" id="L141">    ensureType(shortName, etype);</span>
<span class="fc" id="L142">  }</span>

  public void addStatValue(String shortName, long delta) {
<span class="fc bfc" id="L145" title="All 2 branches covered.">    if (!counterMap.containsKey(shortName)) {</span>
<span class="fc" id="L146">      addStatExportType(shortName, ExportType.AVG);</span>
    }
<span class="fc" id="L148">    MultiWindowGauge stat = counterMap.get(shortName);</span>
<span class="fc" id="L149">    stat.add(delta);</span>
<span class="fc" id="L150">  }</span>

  // fb303
  public long getCounter(String fullName) {
    // todo: convert to a more intelligent table/map version
<span class="fc" id="L155">    int lastDot = fullName.lastIndexOf('.');</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    if (lastDot &lt;= 0) {</span>
<span class="nc" id="L157">      throw new IllegalArgumentException(&quot;Stat name argument '&quot; + fullName</span>
          + &quot;' not found&quot;);
    }

<span class="fc" id="L161">    int preLastDot = -1;</span>
<span class="fc" id="L162">    String shortName = null;</span>
<span class="fc" id="L163">    String ending = null;</span>
<span class="fc" id="L164">    String ending2 = null;</span>
<span class="fc" id="L165">    preLastDot = fullName.lastIndexOf('.', lastDot - 1);</span>
<span class="fc" id="L166">    ending = fullName.substring(lastDot);</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">    if (preLastDot &gt; 0) {</span>
<span class="fc" id="L169">      shortName = fullName.substring(0, preLastDot);</span>
<span class="fc" id="L170">      ending2 = fullName.substring(preLastDot);</span>
    } else {
<span class="fc" id="L172">      shortName = fullName.substring(0, lastDot);</span>
    }

    try {
<span class="fc bfc" id="L176" title="All 2 branches covered.">      if (ending.equals(&quot;.60&quot;)) {</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (ending2.equals(&quot;.sum.60&quot;)) {</span>
<span class="fc" id="L178">          return counterMap.get(shortName).getMinuteSum();</span>
        }
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (ending2.equals(&quot;.avg.60&quot;)) {</span>
<span class="fc" id="L181">          return counterMap.get(shortName).getMinuteAvg();</span>
        }
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (ending2.equals(&quot;.rate.60&quot;)) {</span>
<span class="nc" id="L184">          return counterMap.get(shortName).getMinuteRate();</span>
        }
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (ending2.equals(&quot;.count.60&quot;)) {</span>
<span class="nc" id="L187">          return counterMap.get(shortName).getMinuteSum();</span>
        }
      }

<span class="fc bfc" id="L191" title="All 2 branches covered.">      if (ending.equals(&quot;.600&quot;)) {</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (ending2.equals(&quot;.sum.600&quot;)) {</span>
<span class="fc" id="L193">          return counterMap.get(shortName).getTenMinuteSum();</span>
        }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (ending2.equals(&quot;.avg.600&quot;)) {</span>
<span class="fc" id="L196">          return counterMap.get(shortName).getTenMinuteAvg();</span>
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (ending2.equals(&quot;.rate.600&quot;)) {</span>
<span class="nc" id="L199">          return counterMap.get(shortName).getTenMinuteRate();</span>
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (ending2.equals(&quot;.count.600&quot;)) {</span>
<span class="nc" id="L202">          return counterMap.get(shortName).getTenMinuteSum();</span>
        }
      }

<span class="fc bfc" id="L206" title="All 2 branches covered.">      if (ending.equals(&quot;.3600&quot;)) {</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (ending2.equals(&quot;.sum.3600&quot;)) {</span>
<span class="fc" id="L208">          return counterMap.get(shortName).getHourSum();</span>
        }
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (ending2.equals(&quot;.avg.3600&quot;)) {</span>
<span class="fc" id="L211">          return counterMap.get(shortName).getHourAvg();</span>
        }
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (ending2.equals(&quot;.rate.3600&quot;)) {</span>
<span class="nc" id="L214">          return counterMap.get(shortName).getHourRate();</span>
        }
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (ending2.equals(&quot;.count.3600&quot;)) {</span>
<span class="nc" id="L217">          return counterMap.get(shortName).getHourSum();</span>
        }
      }

<span class="fc bfc" id="L221" title="All 2 branches covered.">      if (fullName.endsWith(&quot;.sum&quot;)) {</span>
<span class="fc" id="L222">        return counterMap.get(shortName).getAllTimeSum();</span>
      }
<span class="fc bfc" id="L224" title="All 2 branches covered.">      if (fullName.endsWith(&quot;.avg&quot;)) {</span>
<span class="fc" id="L225">        return counterMap.get(shortName).getAllTimeAvg();</span>
      }
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">      if (fullName.endsWith(&quot;.rate&quot;)) {</span>
<span class="nc" id="L228">        return counterMap.get(shortName).getAllTimeRate();</span>
      }
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">      if (fullName.endsWith(&quot;.count&quot;)) {</span>
<span class="fc" id="L231">        return counterMap.get(shortName).getAllTimeSum();</span>
      }
<span class="nc" id="L233">    } catch (Exception e) {</span>
<span class="nc" id="L234">      throw new IllegalArgumentException(&quot;Stat name '&quot; + shortName</span>
          + &quot;' not found for '&quot; + ending2 + &quot;' or '&quot; + ending + &quot;'&quot;);
<span class="nc" id="L236">    }</span>

<span class="nc" id="L238">    throw new IllegalArgumentException(&quot;Stat name argument '&quot; + fullName</span>
        + &quot;' not found&quot;);
  }

  /**
   * Returns a new map of results and any missing keys will be missing
   * from output map.
   *
   * fb303-support
   */
  public Map&lt;String, Long&gt; getSelectedCounters(List&lt;String&gt; keys) {
<span class="nc" id="L249">    Map&lt;String, Long&gt; result = new HashMap&lt;String, Long&gt;();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    for (String key : keys) {</span>
      try {
<span class="nc" id="L252">        result.put(key, getCounter(key));</span>
<span class="nc" id="L253">      } catch (IllegalArgumentException e) {</span>
        // okay, result will be missing for this
<span class="nc" id="L255">      }</span>
<span class="nc" id="L256">    }</span>
<span class="nc" id="L257">    return result;</span>
  }

  /**
   * fb303-support
   *
   * @param fullName:  key with the .sum.60 parts, etc
   */
  public boolean hasCounter(String fullName) {
    try {
<span class="nc" id="L267">      getCounter(fullName);</span>
<span class="nc" id="L268">      return true;</span>
<span class="nc" id="L269">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L270">      return false;</span>
    }
  }

  /**
   * Returns true if the shortName has been added already.
   *
   * @param shortName:  The stat name used with addStatExportType does
   *          NOT have the .sum.60 parts, etc
   */
  public boolean containsKey(String shortName) {
<span class="nc" id="L281">    return counterMap.containsKey(shortName);</span>
  }

  /**
   * fb303-support
   */
  public Map&lt;String, Long&gt; getCounters() 
  {
<span class="fc" id="L289">    Map&lt;String, Long&gt; result = new HashMap&lt;String, Long&gt;();</span>
    String fullname;
    long value;
<span class="fc" id="L292">    Set&lt;String&gt; typeKeys = typeMap.keySet();</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">    for (String name : typeKeys) {</span>
<span class="fc" id="L294">      int bitmask = typeMap.get(name);</span>
<span class="fc" id="L295">      MultiWindowGauge stat = counterMap.get(name);</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">      for (ExportType type : ExportType.values()) {</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if ((bitmask &amp; type.value()) == 0) {</span>
<span class="fc" id="L298">          continue;</span>
        }
        // minute
<span class="fc" id="L301">        fullname = String.format(&quot;%s.%s.60&quot;, name, type);</span>
<span class="pc bpc" id="L302" title="1 of 5 branches missed.">        switch (type) {</span>
        case SUM:
<span class="fc" id="L304">          value = stat.getMinuteSum();</span>
<span class="fc" id="L305">          break;</span>
        case COUNT:
<span class="fc" id="L307">          value = stat.getMinuteSum();</span>
<span class="fc" id="L308">          break;</span>
        case AVG:
<span class="fc" id="L310">          value = stat.getMinuteAvg();</span>
<span class="fc" id="L311">          break;</span>
        case RATE:
<span class="fc" id="L313">          value = stat.getMinuteRate();</span>
<span class="fc" id="L314">          break;</span>
        default:
<span class="nc" id="L316">          throw new IndexOutOfBoundsException(&quot;Bad type&quot;);</span>
        }
<span class="fc" id="L318">        result.put(fullname, value);</span>

        // 10 min
<span class="fc" id="L321">        fullname = String.format(&quot;%s.%s.600&quot;, name, type);</span>
<span class="pc bpc" id="L322" title="1 of 5 branches missed.">        switch (type) {</span>
        case SUM:
<span class="fc" id="L324">          value = stat.getTenMinuteSum();</span>
<span class="fc" id="L325">          break;</span>
        case COUNT:
<span class="fc" id="L327">          value = stat.getTenMinuteSum();</span>
<span class="fc" id="L328">          break;</span>
        case AVG:
<span class="fc" id="L330">          value = stat.getTenMinuteAvg();</span>
<span class="fc" id="L331">          break;</span>
        case RATE:
<span class="fc" id="L333">          value = stat.getTenMinuteRate();</span>
<span class="fc" id="L334">          break;</span>
        default:
<span class="nc" id="L336">          throw new IndexOutOfBoundsException(&quot;Bad type&quot;);</span>
        }
<span class="fc" id="L338">        result.put(fullname, value);</span>

        // hour
<span class="fc" id="L341">        fullname = String.format(&quot;%s.%s.3600&quot;, name, type);</span>
<span class="pc bpc" id="L342" title="1 of 5 branches missed.">        switch (type) {</span>
        case SUM:
<span class="fc" id="L344">          value = stat.getHourSum();</span>
<span class="fc" id="L345">          break;</span>
        case COUNT:
<span class="fc" id="L347">          value = stat.getHourSum();</span>
<span class="fc" id="L348">          break;</span>
        case AVG:
<span class="fc" id="L350">          value = stat.getHourAvg();</span>
<span class="fc" id="L351">          break;</span>
        case RATE:
<span class="fc" id="L353">          value = stat.getHourRate();</span>
<span class="fc" id="L354">          break;</span>
        default:
<span class="nc" id="L356">          throw new IndexOutOfBoundsException(&quot;Bad type&quot;);</span>
        }
<span class="fc" id="L358">        result.put(fullname, value);</span>

        // all time
<span class="fc" id="L361">        fullname = String.format(&quot;%s.%s&quot;, name, type);</span>
<span class="pc bpc" id="L362" title="1 of 5 branches missed.">        switch (type) {</span>
        case SUM:
<span class="fc" id="L364">          value = stat.getAllTimeSum();</span>
<span class="fc" id="L365">          break;</span>
        case COUNT:
<span class="fc" id="L367">          value = stat.getAllTimeSum();</span>
<span class="fc" id="L368">          break;</span>
        case AVG:
<span class="fc" id="L370">          value = stat.getAllTimeAvg();</span>
<span class="fc" id="L371">          break;</span>
        case RATE:
<span class="fc" id="L373">          value = stat.getAllTimeRate();</span>
<span class="fc" id="L374">          break;</span>
        default:
<span class="nc" id="L376">          throw new IndexOutOfBoundsException(&quot;Bad type&quot;);</span>
        }
<span class="fc" id="L378">        result.put(fullname, value);</span>

      } // for all export types
<span class="fc" id="L381">    } // for all window stat names</span>
<span class="fc" id="L382">    return result;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>